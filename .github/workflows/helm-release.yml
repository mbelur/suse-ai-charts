name: Helm Chart OCI Publisher and Github Release for each chart

on:
  push:
    branches: [ main ]
  workflow_dispatch:
permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for tagging and comparing history

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.4

      - name: Install yq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          YQ_BIN="/usr/local/bin/yq"
          echo "Installing yq..."
          sudo curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o $YQ_BIN
          sudo chmod +x $YQ_BIN

      - name: Debug actor and repo
        run: |
          echo "Actor: ${{ github.actor }}"
          echo "Repo: ${{ github.repository }}"

      - name: Detect charts
        id: detect
        run: |
          CHARTS=$(ls -d */Chart.yaml | xargs -n1 dirname)
          echo "charts=$(echo $CHARTS | tr '\n' ' ')" >> "$GITHUB_OUTPUT"


      - name: Package charts
        if: ${{ steps.detect.outputs.charts != '' }}
        run: |
          set -euo pipefail
          for chart in ${{ steps.detect.outputs.charts }}; do
            echo "Packaging and pushing $chart"
            cd "$chart"

            VERSION=$(yq -r '.version' Chart.yaml)
            NAME=$(yq -r '.name' Chart.yaml)
            TAG="${NAME}-${VERSION}"

            helm package .

            echo "chart_name=$NAME" >> "$GITHUB_OUTPUT"
            echo "chart_version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "chart_tag=$TAG" >> "$GITHUB_OUTPUT"
            cd ..
          done
        env:
          HELM_EXPERIMENTAL_OCI: 1

      - name: Push charts to OCI
        if: ${{ steps.detect.outputs.charts != '' }}
        run: |
          set -euo pipefail
          for chart in ${{ steps.detect.outputs.charts }}; do
            echo "Packaging and pushing $chart"
            cd "$chart"
            echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ghcr.io --username "github-actions[bot]" --password-stdin
            helm push *.tgz oci://ghcr.io/${{ github.repository }}
            cd ..
          done
        env:
          HELM_EXPERIMENTAL_OCI: 1

      - name: Create GitHub Release for each chart
        if: ${{ steps.detect.outputs.charts != '' }}
        run: |
          set -euo pipefail
          for chart in ${{ steps.detect.outputs.charts }}; do
            VERSION=$(yq -r '.version' $chart/Chart.yaml)
            NAME=$chart
            TAG="${NAME}-${VERSION}"

            echo "Creating GitHub Release for $TAG..."

            # Only create the release if it doesn't already exist
            if gh release view "$TAG" >/dev/null 2>&1; then
              echo "Release $TAG already exists. Skipping."
            else
              gh release create "$TAG" \
                --title "$NAME-$VERSION" \
                --notes "Release for Helm chart **$NAME**, version **$VERSION**" \
                "$chart/${NAME}-${VERSION}.tgz"
              echo "Created GitHub release $TAG"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
